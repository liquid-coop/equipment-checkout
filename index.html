<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Checkout System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #d1d5db; /* gray-300 */
        }
        .status-available { background-color: #10b981; color: #ffffff; } /* green-500 */
        .status-checked-out { background-color: #f59e0b; color: #ffffff; } /* amber-500 */
        .status-overdue { background-color: #ef4444; color: #ffffff; } /* red-500 */
        .status-reserved { background-color: #3b82f6; color: #ffffff; } /* blue-500 */
        .status-returned { background-color: #4b5563; color: #d1d5db; text-decoration: line-through; } /* gray-600 */
        .table-header { background-color: #1f2937; } /* gray-800 */
        .table-cell { padding: 0.75rem 1.5rem; text-align: left; font-size: 0.875rem; color: #d1d5db; } /* gray-300 */
        .table-header-cell { padding: 0.75rem 1.5rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; } /* gray-400 */
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-align: center; }
        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); } /* gray-800, border-gray-700 */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            border-color: #4b5563; /* gray-600 */
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .input-field {
            background-color: #374151; /* gray-700 */
            border-radius: 0.5rem;
            border: 1px solid #4b5563; /* gray-600 */
            padding: 0.5rem 0.75rem;
            width: 100%;
            color: #f3f4f6; /* gray-100 */
        }
        .input-field:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px #4f46e5;
        }
        .nav-btn {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            transition: all 0.2s ease-in-out;
        }
        .nav-btn:hover, .nav-btn.active {
            border-color: #4f46e5;
            color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .nav-btn svg {
            width: 2rem;
            height: 2rem;
        }
        .view { display: none; }
        .view.active { display: block; }
        h1, h2 {
           color: #f9fafb; /* gray-50 */
        }
        label {
            color: #9ca3af; /* gray-400 */
        }
        .divide-y > :not([hidden]) ~ :not([hidden]) {
            border-color: #374151; /* gray-700 */
        }
        .border-b {
            border-color: #374151; /* gray-700 */
        }
        .border-t {
             border-color: #374151; /* gray-700 */
        }
        select option:disabled {
            color: #6b7280; /* gray-500 */
        }
        .sub-nav-btn {
            background-color: transparent;
            border: 1px solid #4b5563;
            color: #9ca3af;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .sub-nav-btn.active {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold">Equipment Checkout System</h1>
        </header>

        <!-- Main Navigation -->
        <div class="mb-8">
            <div id="main-nav" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-4">
                <button class="nav-btn" data-view="reserve">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M12 12.75h.008v.008H12v-.008z" /></svg>
                    Reserve
                </button>
                 <button class="nav-btn" data-view="checkout">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15m0-3l-3-3m0 0l-3 3m3-3v11.25" /></svg>
                    Checkout
                </button>
                 <button class="nav-btn" data-view="checkin">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15V7.5l-2.25 2.25M15 9.75V18l2.25-2.25M9 9.75h6.75" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Checkin
                </button>
                 <button class="nav-btn" data-view="inventory">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                    Inventory
                </button>
                 <button class="nav-btn" data-view="calendar">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /></svg>
                    Calendar
                </button>
                 <button class="nav-btn" data-view="log">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                    Log
                </button>
                <button class="nav-btn" data-view="admin">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 011.45.12l.773.774c.39.39.39 1.024 0 1.414l-.527.737c-.25.35-.272.806-.108 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.11v1.093c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.107 1.204l.527.738c.39.39.39 1.023 0 1.414l-.774.773a1.125 1.125 0 01-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.397.165-.71.505-.781.93l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894c-.071-.424-.384-.764-.781-.93-.398-.164-.854-.142-1.204.108l-.738.527a1.125 1.125 0 01-1.45-.12l-.773-.774a1.125 1.125 0 010-1.414l.527-.737c.25-.35.273-.806.108-1.204-.165-.397-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.11v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.107-1.204l-.527-.738a1.125 1.125 0 01.12-1.45l.773-.773a1.125 1.125 0 011.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.93l.15-.893z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Admin
                </button>
            </div>
        </div>

        <main id="main-content">
            <!-- Reservation Form -->
            <div id="reserve-view" class="view card p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Reserve Equipment</h2>
                <div class="flex items-center space-x-2 mb-4" id="reservation-mode-nav">
                    <button class="sub-nav-btn active" data-mode="new">New Reservation</button>
                    <button class="sub-nav-btn" data-mode="update">Update Existing Reservation</button>
                </div>

                <form id="reservationForm" class="space-y-4">
                    <div>
                        <label for="reservationUser" class="block text-sm font-medium">Your Name</label>
                        <select id="reservationUser" name="reservationUser" class="mt-1 input-field" required></select>
                    </div>

                    <!-- This div will be shown for 'update' mode -->
                    <div id="update-reservation-fields" class="hidden">
                        <label for="existingReservationSelect" class="block text-sm font-medium">Select Your Reservation</label>
                        <select id="existingReservationSelect" class="mt-1 input-field"></select>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                            <label for="startDate" class="block text-sm font-medium">Start Date</label>
                            <input type="date" id="startDate" name="startDate" class="mt-1 input-field" required>
                        </div>
                        <div>
                            <label for="endDate" class="block text-sm font-medium">End Date</label>
                            <input type="date" id="endDate" name="endDate" class="mt-1 input-field" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end pt-4 border-t">
                        <div>
                            <label for="reserveCategoryFilter" class="block text-sm font-medium">Category</label>
                            <select id="reserveCategoryFilter" class="mt-1 input-field"></select>
                        </div>
                        <div>
                            <label for="reserveEquipmentId" class="block text-sm font-medium">Equipment</label>
                            <select id="reserveEquipmentId" name="reserveEquipmentId" class="mt-1 input-field"></select>
                        </div>
                        <button type="button" id="addToReservationBtn" class="btn btn-secondary w-full">Add to Reservation</button>
                    </div>

                    <div id="reservationListContainer" class="space-y-2 pt-4 border-t">
                        <!-- Running list will be injected here -->
                    </div>

                    <div>
                        <button type="submit" id="submitReservationBtn" class="btn btn-primary w-full">Reserve Item</button>
                    </div>
                </form>
                <div id="reservationMessage" class="mt-3 text-sm font-medium"></div>
            </div>

            <!-- Checkout Form -->
            <div id="checkout-view" class="view card p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Log a New Checkout</h2>
                <form id="checkoutForm" class="space-y-4">
                     <div>
                        <label for="checkoutUser" class="block text-sm font-medium">Checked Out By</label>
                        <select id="checkoutUser" name="checkoutUser" class="mt-1 input-field" required></select>
                    </div>
                     <div>
                        <label for="dueDate" class="block text-sm font-medium">Due Date</label>
                        <input type="date" id="dueDate" name="dueDate" class="mt-1 input-field" required>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end pt-4 border-t">
                        <div>
                            <label for="checkoutCategoryFilter" class="block text-sm font-medium">Category</label>
                            <select id="checkoutCategoryFilter" class="mt-1 input-field"></select>
                        </div>
                        <div>
                            <label for="equipmentId" class="block text-sm font-medium">Equipment ID</label>
                            <select id="equipmentId" name="equipmentId" class="mt-1 input-field"></select>
                        </div>
                         <button type="button" id="addToCheckoutBtn" class="btn btn-secondary w-full">Add to Checkout</button>
                    </div>
                    
                    <div id="checkoutListContainer" class="space-y-2 pt-4 border-t">
                        <!-- Running list will be injected here -->
                    </div>

                    <div>
                        <button type="submit" id="submitCheckoutBtn" class="btn btn-primary w-full">Check Out Item</button>
                    </div>
                </form>
                <div id="formError" class="text-red-600 mt-2 text-sm font-medium hidden"></div>
            </div>

            <!-- Equipment Inventory Section -->
            <div id="inventory-view" class="view card overflow-hidden mb-8">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-semibold">Equipment Inventory</h2>
                            <p class="text-sm text-gray-400 mt-1">Master list of all available gear.</p>
                        </div>
                        <div>
                             <label for="categoryFilter" class="sr-only">Filter by Category</label>
                             <select id="categoryFilter" class="input-field text-sm"></select>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y">
                        <thead class="table-header">
                            <tr>
                                <th class="table-header-cell">ID</th>
                                <th class="table-header-cell">Item Name</th>
                                <th class="table-header-cell">Category</th>
                                <th class="table-header-cell">Status</th>
                                <th class="table-header-cell">Checked Out To</th>
                                <th class="table-header-cell">Due Date</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody" class="divide-y"></tbody>
                    </table>
                </div>
            </div>

            <!-- Checkout Log Section -->
            <div id="log-view" class="view card overflow-hidden">
                 <div class="p-6 border-b">
                    <h2 class="text-xl font-semibold">Checkout Log</h2>
                     <p class="text-sm text-gray-400 mt-1">Running history of all checkouts and returns.</p>
                </div>
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="min-w-full divide-y">
                        <thead class="table-header sticky top-0">
                            <tr>
                                <th class="table-header-cell">Item Name</th>
                                <th class="table-header-cell">Checked Out By</th>
                                <th class="table-header-cell">Date Out</th>
                                <th class="table-header-cell">Due Date</th>
                                <th class="table-header-cell">Date Returned</th>
                                <th class="table-header-cell">Action</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Placeholder Views -->
            <div id="checkin-view" class="view card p-6">
                <h2 class="text-xl font-semibold">Check-in System (Coming Soon)</h2>
            </div>
            <div id="calendar-view" class="view card p-6">
                 <h2 class="text-xl font-semibold">Reservation Calendar (Coming Soon)</h2>
            </div>
            <div id="admin-view" class="view card p-6">
                 <h2 class="text-xl font-semibold">Admin Panel (Coming Soon)</h2>
            </div>
        </main>
    </div>

    <script>
        // --- DATA SIMULATION ---
        const inventory = [
            { id: 'CAM-001', name: 'Canon EOS R5', category: 'Camera' },
            { id: 'CAM-002', name: 'Sony A7S III', category: 'Camera' },
            { id: 'MIC-001', name: 'Shure SM7B', category: 'Audio' },
            { id: 'MIC-002', name: 'Rode NTG-3', category: 'Audio' },
            { id: 'LAP-001', name: 'MacBook Pro 16"', category: 'Computer' },
            { id: 'LAP-002', name: 'Dell XPS 15', category: 'Computer' },
            { id: 'TRI-001', name: 'Manfrotto Tripod', category: 'Support' },
        ];

        const users = ['Alice', 'Bob', 'Charlie', 'David', 'Eve'];

        const checkoutLog = [
            { logId: 1, equipmentId: 'CAM-002', name: 'Alice', dateOut: '2025-08-10', dueDate: '2025-08-15', dateReturned: '' },
            { logId: 2, equipmentId: 'LAP-001', name: 'Bob', dateOut: '2025-08-05', dueDate: '2025-08-10', dateReturned: '' },
            { logId: 3, equipmentId: 'MIC-001', name: 'Charlie', dateOut: '2025-08-01', dueDate: '2025-08-08', dateReturned: '2025-08-07' },
        ];
        let nextLogId = 4;

        let reservations = [
             { reservationId: 1, reservationBatchId: 'R20250810-1', equipmentId: 'TRI-001', name: 'David', startDate: '2025-08-20', endDate: '2025-08-22' }
        ];
        let nextReservationId = 2;
        let nextReservationBatchId = 2;
        
        let currentReservationItems = [];
        let currentCheckoutItems = [];
        let reservationMode = 'new'; // 'new' or 'update'
        let selectedReservationBatchId = null;

        // --- UTILITY FUNCTIONS ---
        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        };

        // --- CORE LOGIC ---
        const isDateRangeAvailable = (equipmentId, newStartDate, newEndDate, ignoreBatchId = null) => {
            if (!newStartDate || !newEndDate) return false;
            const newStart = new Date(newStartDate + 'T00:00:00');
            const newEnd = new Date(newEndDate + 'T00:00:00');

            const conflictingCheckout = checkoutLog.find(log => log.equipmentId === equipmentId && log.dateReturned === '');
            if (conflictingCheckout) return false;

            const conflictingReservation = reservations.find(res => {
                if (res.equipmentId !== equipmentId) return false;
                if (ignoreBatchId && res.reservationBatchId === ignoreBatchId) return false;
                const existingStart = new Date(res.startDate + 'T00:00:00');
                const existingEnd = new Date(res.endDate + 'T00:00:00');
                return newStart <= existingEnd && newEnd >= existingStart;
            });

            return !conflictingReservation;
        };

        const calculateInventoryStatus = () => {
            const today = new Date(getTodayDateString() + 'T00:00:00');

            return inventory.map(item => {
                const activeCheckout = checkoutLog.find(log => log.equipmentId === item.id && log.dateReturned === '');
                if (activeCheckout) {
                    const dueDate = new Date(activeCheckout.dueDate + 'T00:00:00');
                    const status = dueDate < today ? 'Overdue' : 'Checked Out';
                    return { ...item, status, checkedOutTo: activeCheckout.name, dueDate: activeCheckout.dueDate };
                }

                const upcomingReservations = reservations
                    .filter(res => res.equipmentId === item.id && new Date(res.startDate + 'T00:00:00') >= today)
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                if (upcomingReservations.length > 0) {
                    const nextReservation = upcomingReservations[0];
                    return { ...item, status: 'Reserved', checkedOutTo: `By ${nextReservation.name}`, dueDate: nextReservation.startDate };
                }

                return { ...item, status: 'Available', checkedOutTo: '', dueDate: '' };
            });
        };

        // --- RENDER FUNCTIONS ---
        const renderInventory = (inventoryWithStatus, filterCategory = 'All') => {
            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = '';

            const filteredInventory = inventoryWithStatus.filter(item => filterCategory === 'All' || item.category === filterCategory);

            if (filteredInventory.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="table-cell text-center text-gray-500">No equipment found.</td></tr>`;
                return;
            }

            filteredInventory.forEach(item => {
                const statusClass = { 'Available': 'status-available', 'Checked Out': 'status-checked-out', 'Overdue': 'status-overdue', 'Reserved': 'status-reserved' }[item.status];
                const dueDateLabel = item.status === 'Reserved' ? `Starts ${formatDate(item.dueDate)}` : formatDate(item.dueDate);

                const row = `
                    <tr>
                        <td class="table-cell font-mono text-xs">${item.id}</td>
                        <td class="table-cell font-medium">${item.name}</td>
                        <td class="table-cell">${item.category}</td>
                        <td class="table-cell"><span class="status-badge ${statusClass}">${item.status}</span></td>
                        <td class="table-cell">${item.checkedOutTo}</td>
                        <td class="table-cell ${item.status === 'Overdue' ? 'font-bold text-red-500' : ''}">${dueDateLabel}</td>
                    </tr>`;
                tableBody.innerHTML += row;
            });
        };

        const renderLog = () => {
            const tableBody = document.getElementById('logTableBody');
            tableBody.innerHTML = '';
            
            const sortedLog = [...checkoutLog].sort((a, b) => new Date(b.dateOut) - new Date(a.dateOut));

            if (sortedLog.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="table-cell text-center text-gray-500">No checkout history.</td></tr>`;
                return;
            }

            sortedLog.forEach(log => {
                const itemDetails = inventory.find(i => i.id === log.equipmentId);
                const isReturned = log.dateReturned !== '';
                const isOverdue = !isReturned && new Date(log.dueDate + 'T00:00:00') < new Date(getTodayDateString() + 'T00:00:00');
                const rowClass = isReturned ? 'status-returned' : (isOverdue ? 'bg-red-800 bg-opacity-20' : '');

                const row = `
                    <tr class="${rowClass}">
                        <td class="table-cell font-medium">${itemDetails ? itemDetails.name : 'N/A'}</td>
                        <td class="table-cell">${log.name}</td>
                        <td class="table-cell">${formatDate(log.dateOut)}</td>
                        <td class="table-cell ${isOverdue ? 'font-bold text-red-400' : ''}">${formatDate(log.dueDate)}</td>
                        <td class="table-cell font-medium ${isReturned ? 'text-green-400' : ''}">${formatDate(log.dateReturned)}</td>
                        <td class="table-cell">${!isReturned ? `<button class="btn btn-secondary text-xs" onclick="returnItem(${log.logId})">Return</button>` : 'Returned'}</td>
                    </tr>`;
                tableBody.innerHTML += row;
            });
        };
        
        const renderReservationList = () => {
            const container = document.getElementById('reservationListContainer');
            const submitBtn = document.getElementById('submitReservationBtn');
            container.innerHTML = '';

            if (currentReservationItems.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-400">No items added to reservation yet.</p>`;
                submitBtn.textContent = 'Reserve Item';
                return;
            }

            currentReservationItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center bg-gray-800 p-2 rounded-md';
                itemEl.innerHTML = `
                    <span class="font-medium text-sm">${item.name} (${item.id})</span>
                    <button type="button" class="text-red-400 hover:text-red-500 font-bold" onclick="removeFromReservation('${item.id}')">&times;</button>
                `;
                container.appendChild(itemEl);
            });

            submitBtn.textContent = `${reservationMode === 'new' ? 'Reserve' : 'Update'} ${currentReservationItems.length} Item${currentReservationItems.length > 1 ? 's' : ''}`;
        };

        const renderCheckoutList = () => {
            const container = document.getElementById('checkoutListContainer');
            const submitBtn = document.getElementById('submitCheckoutBtn');
            container.innerHTML = '';

            if (currentCheckoutItems.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-400">No items added to checkout yet.</p>`;
                submitBtn.textContent = 'Check Out Item';
                return;
            }

            currentCheckoutItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center bg-gray-800 p-2 rounded-md';
                itemEl.innerHTML = `
                    <span class="font-medium text-sm">${item.name} (${item.id})</span>
                    <button type="button" class="text-red-400 hover:text-red-500 font-bold" onclick="removeFromCheckout('${item.id}')">&times;</button>
                `;
                container.appendChild(itemEl);
            });

            submitBtn.textContent = `Check Out ${currentCheckoutItems.length} Item${currentCheckoutItems.length > 1 ? 's' : ''}`;
        };
        
        const populateDropdown = (selectId, items, filterFn, optionTextFn) => {
            const select = document.getElementById(selectId);
            select.innerHTML = `<option value="" disabled selected>Select...</option>`;
            items.filter(filterFn).forEach(item => {
                const option = document.createElement('option');
                option.value = optionTextFn(item).value;
                option.textContent = optionTextFn(item).text;
                select.appendChild(option);
            });
        };
        
        const populateReservationEquipmentDropdown = (inventoryData, reserveCategory, startDate, endDate) => {
            const select = document.getElementById('reserveEquipmentId');
            select.innerHTML = `<option value="" disabled selected>Select equipment...</option>`;

            inventoryData
                .filter(item => {
                    const isInCategory = (reserveCategory === 'All' || item.category === reserveCategory);
                    const notAlreadyAdded = !currentReservationItems.some(rItem => rItem.id === item.id);
                    return isInCategory && notAlreadyAdded;
                })
                .forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} (${item.id})`;

                    const isAvailable = isDateRangeAvailable(item.id, startDate, endDate, selectedReservationBatchId);
                    if (!isAvailable) {
                        option.disabled = true;
                        option.textContent += ' (Unavailable)';
                    }

                    select.appendChild(option);
                });
        };

        const populateCategoryFilter = (selectId) => {
            const select = document.getElementById(selectId);
            const categories = ['All', ...new Set(inventory.map(item => item.category))];
            select.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category === 'All' ? 'All Categories' : category;
                select.appendChild(option);
            });
        };

        const populateUserDropdowns = () => {
            populateDropdown('checkoutUser', users, () => true, user => ({ value: user, text: user }));
            populateDropdown('reservationUser', users, () => true, user => ({ value: user, text: user }));
        };

        const populateExistingReservationsDropdown = (currentUser) => {
            const select = document.getElementById('existingReservationSelect');
            select.innerHTML = '<option value="" disabled selected>Select a reservation to update...</option>';
            
            const userReservations = reservations.filter(r => r.name === currentUser);
            const batchIds = [...new Set(userReservations.map(r => r.reservationBatchId))];

            batchIds.forEach(batchId => {
                const firstItem = userReservations.find(r => r.reservationBatchId === batchId);
                const option = document.createElement('option');
                option.value = batchId;
                option.textContent = `ID: ${batchId} (${formatDate(firstItem.startDate)} - ${formatDate(firstItem.endDate)})`;
                select.appendChild(option);
            });
        };

        // --- EVENT HANDLERS ---
        const handleCheckoutSubmit = (event) => {
            event.preventDefault();
            const form = event.target;
            const errorDiv = document.getElementById('formError');
            errorDiv.classList.add('hidden');

            const name = form.checkoutUser.value;
            const dueDate = form.dueDate.value;

            if (currentCheckoutItems.length === 0) {
                errorDiv.textContent = 'Please add at least one item to check out.';
                errorDiv.classList.remove('hidden');
                return;
            }
            if (!name || !dueDate) {
                errorDiv.textContent = 'Please provide your name and a due date.';
                errorDiv.classList.remove('hidden');
                return;
            }

            currentCheckoutItems.forEach(item => {
                checkoutLog.push({ logId: nextLogId++, equipmentId: item.id, name, dateOut: getTodayDateString(), dueDate, dateReturned: '' });
            });
            
            currentCheckoutItems = [];
            form.reset();
            updateAndRenderAll();
        };

        const handleReservationSubmit = (event) => {
            event.preventDefault();
            const form = event.target;
            const messageDiv = document.getElementById('reservationMessage');
            messageDiv.textContent = '';

            const name = form.reservationUser.value;
            const startDate = form.startDate.value;
            const endDate = form.endDate.value;

            if (currentReservationItems.length === 0) {
                messageDiv.textContent = 'Please add at least one item.';
                messageDiv.className = 'mt-3 text-sm font-medium text-red-400';
                return;
            }
            if (!name || !startDate || !endDate) {
                messageDiv.textContent = 'Please provide your name, a start date, and an end date.';
                messageDiv.className = 'mt-3 text-sm font-medium text-red-400';
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                messageDiv.textContent = 'End date must be after the start date.';
                messageDiv.className = 'mt-3 text-sm font-medium text-red-400';
                return;
            }
            
            if (reservationMode === 'new') {
                const date = new Date();
                const batchId = `R${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}-${nextReservationBatchId++}`;
                
                currentReservationItems.forEach(item => {
                    reservations.push({ reservationId: nextReservationId++, reservationBatchId: batchId, equipmentId: item.id, name, startDate, endDate });
                });
                messageDiv.textContent = `Reservation ${batchId} successful!`;
                messageDiv.className = 'mt-3 text-sm font-medium text-green-400';

            } else if (reservationMode === 'update' && selectedReservationBatchId) {
                // Remove old entries for this batch
                reservations = reservations.filter(r => r.reservationBatchId !== selectedReservationBatchId);
                // Add updated entries
                currentReservationItems.forEach(item => {
                    reservations.push({ reservationId: nextReservationId++, reservationBatchId: selectedReservationBatchId, equipmentId: item.id, name, startDate, endDate });
                });
                messageDiv.textContent = `Reservation ${selectedReservationBatchId} updated successfully!`;
                messageDiv.className = 'mt-3 text-sm font-medium text-green-400';
            }
            
            currentReservationItems = [];
            form.reset();
            switchReservationMode('new');
            updateAndRenderAll();
        };
        
        const handleAddToReservation = () => {
            const equipmentId = document.getElementById('reserveEquipmentId').value;
            if (!equipmentId) return;

            const alreadyAdded = currentReservationItems.some(item => item.id === equipmentId);
            if (alreadyAdded) return;

            const itemDetails = inventory.find(item => item.id === equipmentId);
            if (itemDetails) {
                currentReservationItems.push(itemDetails);
                updateAndRenderAll();
            }
        };

        const handleAddToCheckout = () => {
            const equipmentId = document.getElementById('equipmentId').value;
            if (!equipmentId) return;

            const alreadyAdded = currentCheckoutItems.some(item => item.id === equipmentId);
            if (alreadyAdded) return;

            const itemDetails = inventory.find(item => item.id === equipmentId);
            if (itemDetails) {
                currentCheckoutItems.push(itemDetails);
                updateAndRenderAll();
            }
        };
        
        window.removeFromReservation = (equipmentId) => {
            currentReservationItems = currentReservationItems.filter(item => item.id !== equipmentId);
            updateAndRenderAll();
        };
        
        window.removeFromCheckout = (equipmentId) => {
            currentCheckoutItems = currentCheckoutItems.filter(item => item.id !== equipmentId);
            updateAndRenderAll();
        };

        window.returnItem = (logId) => {
            const logEntry = checkoutLog.find(log => log.logId === logId);
            if (logEntry) {
                logEntry.dateReturned = getTodayDateString();
                updateAndRenderAll();
            }
        };
        
        const switchView = (viewName) => {
            document.querySelectorAll('#main-nav .nav-btn').forEach(btn => btn.classList.remove('active'));
            const clickedButton = document.querySelector(`#main-nav .nav-btn[data-view="${viewName}"]`);
            if (clickedButton) clickedButton.classList.add('active');

            document.querySelectorAll('#main-content .view').forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) targetView.classList.add('active');
        };

        const switchReservationMode = (mode) => {
            reservationMode = mode;
            document.querySelectorAll('#reservation-mode-nav .sub-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#reservation-mode-nav .sub-nav-btn[data-mode="${mode}"]`).classList.add('active');

            const updateFields = document.getElementById('update-reservation-fields');
            const submitBtn = document.getElementById('submitReservationBtn');
            const nameField = document.getElementById('reservationUser');
            
            currentReservationItems = [];
            document.getElementById('reservationForm').reset();
            
            if (mode === 'new') {
                updateFields.classList.add('hidden');
                submitBtn.textContent = 'Reserve Item';
                selectedReservationBatchId = null;
                nameField.disabled = false;
            } else {
                updateFields.classList.remove('hidden');
                submitBtn.textContent = 'Update Reservation';
                const currentUser = nameField.value;
                populateExistingReservationsDropdown(currentUser);
            }
            updateAndRenderAll();
        };

        // --- INITIALIZATION ---
        const updateAndRenderAll = () => {
            const inventoryWithStatus = calculateInventoryStatus();
            const invCategory = document.getElementById('categoryFilter').value;
            const checkoutCategory = document.getElementById('checkoutCategoryFilter').value;
            const reserveCategory = document.getElementById('reserveCategoryFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            renderInventory(inventoryWithStatus, invCategory);
            renderLog();
            renderReservationList();
            renderCheckoutList();
            
            populateDropdown('equipmentId', inventoryWithStatus, item => {
                const isInCategory = (checkoutCategory === 'All' || item.category === checkoutCategory);
                const notAlreadyAdded = !currentCheckoutItems.some(cItem => cItem.id === item.id);
                return item.status === 'Available' && isInCategory && notAlreadyAdded;
            }, item => ({ value: item.id, text: `${item.name} (${item.id})` }));
            
            populateReservationEquipmentDropdown(inventory, reserveCategory, startDate, endDate);
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('checkoutForm').addEventListener('submit', handleCheckoutSubmit);
            document.getElementById('reservationForm').addEventListener('submit', handleReservationSubmit);
            document.getElementById('addToReservationBtn').addEventListener('click', handleAddToReservation);
            document.getElementById('addToCheckoutBtn').addEventListener('click', handleAddToCheckout);
            
            document.querySelectorAll('#reservation-mode-nav .sub-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => switchReservationMode(btn.dataset.mode));
            });

            document.getElementById('reservationUser').addEventListener('change', (e) => {
                if(reservationMode === 'update') {
                    populateExistingReservationsDropdown(e.target.value);
                }
            });

            document.getElementById('existingReservationSelect').addEventListener('change', (e) => {
                selectedReservationBatchId = e.target.value;
                if (!selectedReservationBatchId) return;

                const batchItems = reservations.filter(r => r.reservationBatchId === selectedReservationBatchId);
                if (batchItems.length > 0) {
                    document.getElementById('startDate').value = batchItems[0].startDate;
                    document.getElementById('endDate').value = batchItems[0].endDate;
                    document.getElementById('reservationUser').value = batchItems[0].name;
                    currentReservationItems = batchItems.map(resItem => inventory.find(invItem => invItem.id === resItem.equipmentId));
                    updateAndRenderAll();
                }
            });
            
            document.getElementById('startDate').addEventListener('change', updateAndRenderAll);
            document.getElementById('endDate').addEventListener('change', updateAndRenderAll);

            document.getElementById('categoryFilter').addEventListener('change', updateAndRenderAll);
            document.getElementById('checkoutCategoryFilter').addEventListener('change', updateAndRenderAll);
            document.getElementById('reserveCategoryFilter').addEventListener('change', updateAndRenderAll);
            
            const today = getTodayDateString();
            document.getElementById('dueDate').min = today;
            document.getElementById('startDate').min = today;
            document.getElementById('endDate').min = today;
            document.getElementById('startDate').addEventListener('change', (e) => {
                 document.getElementById('endDate').min = e.target.value;
            });

            document.querySelectorAll('#main-nav .nav-btn').forEach(btn => {
                btn.addEventListener('click', () => switchView(btn.dataset.view));
            });
            
            populateCategoryFilter('categoryFilter');
            populateCategoryFilter('checkoutCategoryFilter');
            populateCategoryFilter('reserveCategoryFilter');
            populateUserDropdowns();
            updateAndRenderAll();
        });

    </script>
</body>
</html>
